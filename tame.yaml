settings:
  init: "set -e"

globals:
  $platforms:
    linux:
      os: "linux"
      arch: "amd64"
    mac:
      os: "darwin"
      arch: "amd64"
  $docker:
    image: "kassybas/tame"

targets:

  echo:
    run:
      - sh: echo $platforms_linux_arch

  local-build:
    run:
    - call build: { $platform: $platforms.mac}
  
  build-all:
    run:
    - call build: { $platform: $platforms.mac}
    - call build: { $platform: $platforms.linux}

  build:
    args: { $platform } 
    run: 
    - sh: |
        echo "Building for ${platform_os}:${platform_arch}..."
        mkdir -p bin
        GOOS=${platform_os} GOARCH=${platform_arch} go build -o bin/tame_${platform_os}_${platform_arch}
  
  docker-build:
    args: { $version: "latest"}
    run:
    - call build: { $platform: $platforms.linux }
    - var $os: $platforms.linux.os
    - var $arch: $platforms.linux.arch
    - sh: docker build --build-arg=bin/tame_${os}_${arch} -t ${docker_image}:${version} .
    
  clean-bin:
    run:
      - sh: rm -rf ./bin/*
  
  test:
    run:
    - sh: go test ./...
